#!/bin/bash
# Wrapper to normalize base64 decode flags and optionally ignore garbage characters.
# Ensures CocoaPods prepare_command base64 decoding works on macOS and other platforms.
set -eu
args=("$@")
decode=0
ignore_garbage=0
for a in "${args[@]}"; do
  case "$a" in
    --decode|-d|-D)
      decode=1
      ;;
    --ignore-garbage)
      ignore_garbage=1
      ;;
  esac
done

if [ "$decode" -eq 1 ]; then
  if [ "$ignore_garbage" -eq 1 ]; then
    # strip non-base64 characters then decode
    sed 's/[^A-Za-z0-9+/=]//g'
  else
    cat
  fi | (
    if [ "$(uname)" = "Darwin" ]; then
      command base64 -D
    else
      command base64 --decode
    fi
  )
else
  # forward other invocations to system base64
  command base64 "$@"
fi
